// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin user (single admin only)
model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  auditLogs AuditLog[]
  settings  Setting[]
  
  @@map("admins")
}

// Products with multi-language support
model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  price       Float
  stock       Int      @default(0)
  isActive    Boolean  @default(true)
  featured    Boolean  @default(false)
  weight      Float?   // For shipping calculation
  videoUrl    String?  // Short video URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Multi-language content
  translations ProductTranslation[]
  
  // Relations
  images      ProductImage[]
  cartItems   CartItem[]
  orderItems  OrderItem[]
  benefits    ProductBenefit[]
  testimonials Testimonial[]
  
  @@map("products")
}

model ProductTranslation {
  id          String @id @default(cuid())
  productId   String
  language    String // ar, fr, en
  title       String
  description String
  shortDesc   String?
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([productId, language])
  @@map("product_translations")
}

model ProductImage {
  id        String @id @default(cuid())
  productId String
  url       String
  alt       String?
  order     Int    @default(0)
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("product_images")
}

model ProductBenefit {
  id        String @id @default(cuid())
  productId String
  icon      String?
  text      String
  order     Int    @default(0)
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("product_benefits")
}

model Testimonial {
  id        String @id @default(cuid())
  productId String
  name      String
  message   String
  rating    Int    @default(5)
  image     String?
  isActive  Boolean @default(true)
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("testimonials")
}

// Algerian Wilayas and Municipalities
model Wilaya {
  id          String @id @default(cuid())
  code        String @unique // 01-58
  name        String
  nameAr      String
  shippingCost Float @default(0)
  
  // Relations
  municipalities Municipality[]
  shippingRates ShippingRate[]
  
  @@map("wilayas")
}

model Municipality {
  id           String @id @default(cuid())
  wilayaId     String
  name         String
  nameAr       String
  daira        String
  dairaAr      String
  
  wilaya Wilaya @relation(fields: [wilayaId], references: [id], onDelete: Cascade)
  
  @@map("municipalities")
}

// Shipping rates configuration
model ShippingRate {
  id       String  @id @default(cuid())
  wilayaId String
  type     String  // "weight" or "price"
  minValue Float
  maxValue Float?
  cost     Float
  isActive Boolean @default(true)
  
  wilaya Wilaya @relation(fields: [wilayaId], references: [id], onDelete: Cascade)
  
  @@map("shipping_rates")
}

// Cart (optional feature)
model Cart {
  id        String   @id @default(cuid())
  sessionId String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  items CartItem[]
  
  @@map("carts")
}

model CartItem {
  id        String @id @default(cuid())
  cartId    String
  productId String
  quantity  Int    @default(1)
  
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([cartId, productId])
  @@map("cart_items")
}

// Orders
model Order {
  id            String   @id @default(cuid())
  orderNumber   String   @unique
  status        String   @default("pending") // pending, confirmed, shipped, delivered, cancelled
  totalAmount   Float
  shippingCost  Float    @default(0)
  paymentMethod String   @default("cod") // Cash on Delivery
  customerName  String
  customerPhone String
  customerEmail String?
  address       String
  wilayaId      String
  municipality  String
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  items        OrderItem[]
  statusHistory OrderStatusHistory[]
  
  @@map("orders")
}

model OrderItem {
  id       String @id @default(cuid())
  orderId  String
  productId String
  quantity  Int
  unitPrice Float
  
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  
  @@map("order_items")
}

model OrderStatusHistory {
  id        String   @id @default(cuid())
  orderId   String
  status    String
  notes     String?
  createdAt DateTime @default(now())
  
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("order_status_history")
}

// Lead capture system
model Lead {
  id          String   @id @default(cuid())
  name        String
  phone       String
  email       String?
  source      String   // "telegram", "messenger", "ads", "manual"
  status      String   @default("new") // new, contacted, converted, rejected
  answers     Json?    // Custom questions answers
  notes       String?
  assignedTo  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  messages LeadMessage[]
  
  @@map("leads")
}

model LeadMessage {
  id        String   @id @default(cuid())
  leadId    String
  type      String   // "inbound" or "outbound"
  content   String
  channel   String   // "telegram", "messenger", "email", "manual"
  createdAt DateTime @default(now())
  
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  @@map("lead_messages")
}

// Recruitment system templates
model RecruitmentTemplate {
  id          String @id @default(cuid())
  type        String // "welcome", "question", "followup"
  language    String // ar, fr, en
  title       String?
  content     String
  isActive    Boolean @default(true)
  order       Int    @default(0)
  
  @@map("recruitment_templates")
}

model RecruitmentQuestion {
  id       String @id @default(cuid())
  question String
  type     String // "text", "choice", "rating"
  options  Json?  // For choice questions
  required Boolean @default(false)
  order    Int    @default(0)
  isActive Boolean @default(true)
  
  @@map("recruitment_questions")
}

// System settings
model Setting {
  id        String @id @default(cuid())
  key       String @unique
  value     Json
  updatedBy String?
  updatedAt DateTime @updatedAt
  
  admin Admin? @relation(fields: [updatedBy], references: [id])
  
  @@map("settings")
}

// Audit logs
model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String   // "create", "update", "delete"
  entity    String   // "product", "order", "lead", etc.
  entityId  String?
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  admin Admin @relation(fields: [adminId], references: [id])
  
  @@map("audit_logs")
}

// Translation keys for UI
model Translation {
  id        String @id @default(cuid())
  key       String
  language  String // ar, fr, en
  value     String
  
  @@unique([key, language])
  @@map("translations")
}
